# FSO на Arduino Mega 2560

### Это исходный код проекта "Лазерная Система Связи (ЛСС)" для проекта Лунной Базы

## Что такое FSO?

**FSO (Free-Space Optics) - технология беспроводной оптической передачи информации с помощью инфракрасного лазера**. Сам принцип передачи информации ничем не отличается от радио - информация кодируется в последовательность из **0** и **1** **(0 - лазер выключен | 1 - лазер включен)** и передается в приемник. Только в отличии от радио передачи, здесь используется тип связи **"точка-точка"**, что усложняет создание прочного канала связи.

![FSO_Work](https://github.com/NoobieNightCoder/FSO_Arduino/blob/main/Photos/FSO_Work.png?raw=true)

---

## Реализация

Данная технология была реализована с использованием **2-ух** микроконтроллеров типа **Arduino Mega 2560**. Коммуникация происходит через **UART** по **Serial1 порту** со скоростью **9600 Бод**. Выведение сообщений / картинок происходит на TFT дисплей 128x160 пикселей. В качестве передатчика используется **Лазер KY-008** и самодельный приемник на базе **Фотодиода BWP34** и **Усилителя LM358P**. Схема приемника:

![Receiver](https://github.com/NoobieNightCoder/FSO_Arduino/blob/main/Photos/Receiver_Schema.png?raw=true)

## TFT Дисплей

### Как подключать: 

Ставим [библиотеку](https://drive.google.com/file/d/13iEGENm7yNeln5X96yzZ9AeTXqh_Qyks/view?usp=sharing) из архива, подключаем по схеме:

```cpp
#define TFT_CS   10
#define TFT_DC    9
#define TFT_RST   8
```

**!! Пин BL подрубаем туда, где есть PWM ( ШИМ ), там на плате есть транзистор что отвечает за подсветку, это не сильно важно и если не надо её регулировать, то просто подрубаем к пину 3.3В через резистор на 1КОм !!**

### Свойства связи:

* **Максимально возможная скорость (Нестабильная): 19.2 Кбит/сек**

* **Максимальная стабильная скорость: 9.6 Кбит/сек**

* **Максимальная фактическая скорость: 8 Кбит/сек**

* **Шанс появления битого символа: 0.46%**

---

# Конфигурации

## Односторонняя передача

### Text

Конфигурация для отладки односторонней передачи информации.

#### Transmitter_Text
Код для **передатчика**. Передает сообщение **"Hello world!"**. Текст сообщения можно изменить в этой строке:

```cpp
String message = "Hello world!";   // 15 строка
```

#### Receiver_Text

Код для **приемника**. Выводит полученное сообщение в **COM (Serial)** порт.

**! Если приемник получает битые данные, то нужно поиграться с прицеливанием. Временами нужно целиться в край фотодиода, чтобы тот зафиксировал все импульсы !**

### TextDisplaySend

Конфигурация для отправки сообщения в одну сторону и его выведение на TFT дисплей.

![Text](https://github.com/NoobieNightCoder/FSO_Arduino/blob/main/Photos/Text.png?raw=true)

#### Transmitter_TextDisplay

Код для **передатчика**. Передает сообщение **"Hello world!"**. Текст сообщения можно изменить в этой строке:

```cpp
String message = "Hello world!";   // 14 строка
```

#### Receiver_TextDisplay

Код для **приемника**. Выводит полученное сообщение на TFT дисплей. 

### PhotoDisplay

Конфигурация для отправки изображения и его выведение на TFT дисплей.

![Image](https://github.com/NoobieNightCoder/FSO_Arduino/blob/main/Photos/Image.png?raw=true)

#### Transmitter_PhotoDisplay

Код для **передатчика**. Передает картинку по пикселям через пакеты формата:

```bash
[X_COORDINATE, Y_COORDINATE, HEX_COLOR]
```

В коде уже есть 2 примера изображения размером 120x120 пикселей. Чтобы поменять изображение, нужно закомментировать строчку с прошлым изображением и раскомментировать строчку с другим изображением:

```cpp
// 4-ая строка

// Examples of images
#include "example1.h"         // 120x120 Image
// #include "example2.h"      // 120x120 Image
```

Чтобы передать свое изображение, необходимо конвертировать его в файл формата **.h**, содержащий шестнадцатеричный код цвета каждого пикселя, и поместить его в папку с .ino файлом и подключить его таким образом:

```cpp
#include "Название вашего .h файла"
```

К примеру, можно использовать [этот](https://alexgyver.ru/led-backpack/) конвертер от AlexGyver. Скачиваете архив и в папке **GyverMatrixWiFi-master** находите папку **image decoding**, где лежит необходимый нам конвертер **ImageDecoder_1.1.1.exe**. Сначала выбираете размер, а потом нажимаете на кнопку.

Далее вам нужно будет при необходимости внести новые размеры изображения в данных строчках:

```cpp
// 8-ая строка

// The size of the Image
#define imageHeight 120   // Высота изображения
#define imageWidth 120    // Длина изображения
```

**Это необходимо сделать и в программе передатчика, и в программе приемника.**

**!!! ВАЖНО ЧТОБЫ 1-АЯ СТРОКА .h ФАЙЛА ВЫГЛЯДИЛА ВОТ ТАК !!!**

```cpp
const uint16_t SendImage[] PROGMEM = {
```

**А также уточнение, что для отправки изображения размером более 120x120 пикселей придется разбивать данный файл на несколько массивов, так как  программное ограничение IDE стоит в районе 16300 элементов для одного массива :)**

#### Receiver_PhotoDisplay

Код для **приемника**. Выводит полученные пиксели на **TFT дисплей**.

**!! При изменении размера передаваемого изображения, необходимо эти изменения ввести и здесь !!**

```cpp
// 14-ая строка

// The size of transmitted image
#define imageWidth 120    // Длина изображения
#define imageHeight 120   // Высота изображения
```

---

## Двусторонняя передача

### TextDisplay

Конфигурация для передачи сообщения в обе стороны.

Код и для **передатчика**, и для **приемника**. Пересылают друг другу введённое пользователем в **COM (Serial)** порт сообщение.
